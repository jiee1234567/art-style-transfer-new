<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>艺境</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .style-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: -2;
        }

        .style-background.vangogh {
            background-image: url('./styles/vangogh.jpg');
        }

        .style-background.ukiyoe {
            background-image: url('./styles/ukiyoe.jpg');
        }

        .style-background.cyberpunk {
            background-image: url('./styles/cyberpunk.jpg');
        }

        .style-background.active {
            opacity: 0.25;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-size: 24px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-button {
            padding: 8px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-button.active {
            background: #6C5CE7;
            border-color: #6C5CE7;
        }

        .diamond-toggle {
            width: 22px;
            height: 22px;
            background: rgba(255, 255, 255, 0.6);
            transform: rotate(45deg);
            border: none;
            margin-right: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .diamond-toggle:hover {
            background: rgba(108, 92, 231, 0.8);
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.6);
            transform: rotate(45deg) scale(1.1);
        }

        .diamond-toggle.active {
            background: #6C5CE7;
            box-shadow: 0 0 10px rgba(108, 92, 231, 0.4);
        }

        .diamond-toggle::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: -100%;
            left: -100%;
            background: linear-gradient(135deg, transparent 45%, rgba(255, 255, 255, 0.5) 50%, transparent 55%);
            transition: all 0.3s ease;
        }

        .diamond-toggle:hover::after {
            top: 0;
            left: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 20px 80px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .main-content h2 {
            margin-bottom: 10px;
            margin-top: 5px;
        }

        .upload-area {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/10;
            background: rgba(0, 0, 0, 0.8);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .upload-area:hover {
            border-color: rgba(108, 92, 231, 0.6);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3);
            transform: translateY(-2px);
            background: rgba(0, 0, 0, 0.4);
        }

        .upload-area img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .upload-area.has-image .upload-icon,
        .upload-area.has-image .upload-text {
            display: none;
        }

        .upload-area.has-image img {
            display: block;
        }

        .upload-area.has-image img {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .upload-icon {
            font-size: 54px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            text-align: center;
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin-top: 15px;
            margin-bottom: 15px;
            position: relative;
            z-index: 5;
        }

        .style-option {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            background-color: #fff;
        }

        .style-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(108, 92, 231, 0.4);
        }

        .style-option.active {
            border-color: #6C5CE7;
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.5);
            transform: translateY(-3px);
        }

        .style-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease;
            opacity: 1;
        }

        .style-option:hover img {
            transform: scale(1.05);
        }

        .style-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9) !important;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
        }

        .style-option:hover .style-name {
            background: rgba(108, 92, 231, 0.8);
            transform: translateY(-3px);
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            width: 100%;
            max-width: 800px;
            justify-content: center;
            position: relative;
            z-index: 10;
            padding: 15px;
            border-radius: 40px;
            background: rgba(0, 0, 0, 0.3);
        }

        .action-button {
            min-width: 120px;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #6C5CE7;
            color: white;
            text-align: center;
            opacity: 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .action-button.undo {
            background: rgba(40, 40, 40, 0.9);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        #imageInput {
            display: none;
        }

        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-container.active {
            display: flex;
        }

        #camera-video {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            object-fit: cover;
        }

        .camera-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
        }

        .camera-button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #6C5CE7;
            color: white;
        }

        .camera-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .camera-button.close {
            background: rgba(255, 255, 255, 0.2);
        }

        .postcard-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .postcard-container.active {
            display: flex;
        }

        .postcard-canvas-container {
            position: relative;
            max-width: 100%;
            max-height: 80vh;
        }

        .postcard-canvas {
            max-width: 100%;
            max-height: 80vh;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: white;
        }

        .postcard-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .postcard-button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #6C5CE7;
            color: white;
        }

        .postcard-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .postcard-button.close {
            background: rgba(255, 255, 255, 0.2);
        }

        .image-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .image-control-label {
            color: white;
            font-size: 14px;
        }

        .image-control-slider {
            width: 150px;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .image-control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6C5CE7;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-control-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .preview-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .preview-image-container {
            position: relative;
            background: transparent;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.6);
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preview-image-container img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .preview-text {
            color: white;
            margin-top: 15px;
            font-size: 16px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .preview-controls {
            margin-top: 15px;
        }

        .preview-button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #6C5CE7;
            color: white;
        }

        .preview-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .close-preview {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #ff4444;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1;
            transition: all 0.3s;
        }

        .close-preview:hover {
            background: #ff0000;
            transform: scale(1.1);
        }

        .diamond {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            transform: rotate(45deg);
            cursor: pointer;
            transition: transform 0.3s ease;
            animation: twinkle 2s infinite;
            pointer-events: auto;
            z-index: 2;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes twinkle {
            0% { opacity: 0.3; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
            50% { opacity: 1; box-shadow: 0 0 15px rgba(255, 255, 255, 0.7); }
            100% { opacity: 0.3; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
        }

        @keyframes fall {
            to {
                transform: rotate(45deg) translateY(100vh);
                opacity: 0;
                box-shadow: 0 0 0 rgba(255, 255, 255, 0);
            }
        }

        .postcard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .postcard-modal.active {
            display: flex;
        }

        .postcard-content {
            position: relative;
            background: #1a1a1a;
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .postcard-canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: -10px;
        }

        #postcardCanvas {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .image-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .image-control-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .image-control-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .image-control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6C5CE7;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-control-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #8177e9;
        }

        .postcard-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .postcard-button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: #6C5CE7;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            min-width: 120px;
        }

        .postcard-button:hover {
            transform: translateY(-2px);
            background: #8177e9;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .close-preview {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #ff4444;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1;
            transition: all 0.3s;
        }

        .close-preview:hover {
            background: #ff0000;
            transform: scale(1.1);
        }

        .background-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        #diamond-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .style-background {
            z-index: -2;
        }

        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease;
            background-color: transparent;
        }

        .background-animation.active {
            opacity: 1;
        }

        video.background-animation {
            background-color: transparent !important;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .background-animation-container video {
            mix-blend-mode: screen;
            background-color: transparent;
        }

        /* 开场动画的样式 */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            transition: opacity 1s ease;
        }
        
        .intro-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .intro-text {
            font-family: "Arial", sans-serif;
            font-size: 90px; /* 放大到2.5倍(2.5*36=90) */
            font-weight: bold;
            color: white;
            text-align: center;
            max-width: 1200px; /* 增加最大宽度以容纳更大的文字 */
            white-space: nowrap; /* 确保文字在一行 */
            cursor: pointer;
            padding: 20px 40px;
            border-radius: 10px;
            position: relative;
            text-shadow: 0 0 10px rgba(128, 0, 255, 0.7), 0 0 20px rgba(128, 0, 255, 0.5);
            letter-spacing: 2px;
            opacity: 0;
            animation: fadeIn 2s ease-in-out forwards 1s;
            transition: transform 0.3s ease, text-shadow 0.3s ease;
        }
        
        .intro-text:hover {
            transform: scale(1.05);
            text-shadow: 0 0 15px rgba(128, 0, 255, 0.9), 0 0 30px rgba(128, 0, 255, 0.7), 0 0 45px rgba(128, 0, 255, 0.5);
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .ripple {
            position: absolute;
            pointer-events: none;
            width: 50px; /* 基础宽度 */
            height: 50px; /* 基础高度 */
        }
        
        /* 生成10个同心圆，使用伪元素和子元素 */
        .ripple::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid rgba(210, 150, 255, 0.9);
            animation: rippleEffect1 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            border-radius: 50%;
            border: 1px solid rgba(220, 160, 255, 0.9);
            animation: rippleEffect2 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-1 {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 1px solid rgba(230, 170, 255, 0.9);
            animation: rippleEffect3 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-2 {
            position: absolute;
            top: 15%;
            left: 15%;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            border: 1px solid rgba(240, 180, 255, 0.9);
            animation: rippleEffect4 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-3 {
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            border: 1px solid rgba(250, 190, 255, 0.9);
            animation: rippleEffect5 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-4 {
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            border-radius: 50%;
            border: 1px solid rgba(255, 200, 255, 0.9);
            animation: rippleEffect6 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-5 {
            position: absolute;
            top: 30%;
            left: 30%;
            width: 40%;
            height: 40%;
            border-radius: 50%;
            border: 1px solid rgba(255, 210, 255, 0.9);
            animation: rippleEffect7 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-6 {
            position: absolute;
            top: 35%;
            left: 35%;
            width: 30%;
            height: 30%;
            border-radius: 50%;
            border: 1px solid rgba(255, 220, 255, 0.9);
            animation: rippleEffect8 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .circle-7 {
            position: absolute;
            top: 40%;
            left: 40%;
            width: 20%;
            height: 20%;
            border-radius: 50%;
            border: 1px solid rgba(255, 230, 255, 0.9);
            animation: rippleEffect9 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        .ripple .inner-dot {
            position: absolute;
            top: 45%;
            left: 45%;
            width: 10%;
            height: 10%;
            border-radius: 50%;
            background: rgba(255, 240, 255, 1);
            animation: rippleEffect10 4s ease-out forwards; /* 持续时间延长到4秒 */
        }
        
        /* 动画关键帧，增加扩散范围到原来的2倍 */
        @keyframes rippleEffect1 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(210, 150, 255, 1); }
            100% { transform: scale(16); opacity: 0; border-color: rgba(210, 150, 255, 0); } /* 扩散范围增加到原来的2倍 */
        }
        
        @keyframes rippleEffect2 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(220, 160, 255, 1); }
            100% { transform: scale(15); opacity: 0; border-color: rgba(220, 160, 255, 0); }
        }
        
        @keyframes rippleEffect3 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(230, 170, 255, 1); }
            100% { transform: scale(14); opacity: 0; border-color: rgba(230, 170, 255, 0); }
        }
        
        @keyframes rippleEffect4 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(240, 180, 255, 1); }
            100% { transform: scale(13); opacity: 0; border-color: rgba(240, 180, 255, 0); }
        }
        
        @keyframes rippleEffect5 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(250, 190, 255, 1); }
            100% { transform: scale(12); opacity: 0; border-color: rgba(250, 190, 255, 0); }
        }
        
        @keyframes rippleEffect6 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(255, 200, 255, 1); }
            100% { transform: scale(11); opacity: 0; border-color: rgba(255, 200, 255, 0); }
        }
        
        @keyframes rippleEffect7 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(255, 210, 255, 1); }
            100% { transform: scale(10); opacity: 0; border-color: rgba(255, 210, 255, 0); }
        }
        
        @keyframes rippleEffect8 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(255, 220, 255, 1); }
            100% { transform: scale(9); opacity: 0; border-color: rgba(255, 220, 255, 0); }
        }
        
        @keyframes rippleEffect9 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); border-color: rgba(255, 230, 255, 1); }
            100% { transform: scale(8); opacity: 0; border-color: rgba(255, 230, 255, 0); }
        }
        
        @keyframes rippleEffect10 {
            0% { transform: scale(0); opacity: var(--ripple-opacity, 0.8); background-color: rgba(255, 240, 255, 1); }
            100% { transform: scale(7); opacity: 0; background-color: rgba(255, 240, 255, 0); }
        }
        
        .intro-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: none;
            background-color: transparent; /* 改为透明背景 */
        }
        
        .intro-animation video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: screen; /* 添加混合模式以确保透明度效果 */
            background-color: transparent; /* 确保背景透明 */
        }
    </style>
</head>
<body>
    <div id="diamond-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;"></div>

    <div class="style-background vangogh active"></div>
    <div class="style-background ukiyoe"></div>
    <div class="style-background cyberpunk"></div>

    <header class="header">
        <a href="#" class="logo">
            <span class="logo-icon">✨</span>
            艺境
        </a>
        <div class="nav-buttons">
            <button class="diamond-toggle" id="stars-toggle" aria-label="星星效果开关"></button>
            <button class="nav-button">相机</button>
            <button class="nav-button active">相册</button>
        </div>
    </header>

    <main class="main-content">
        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
            <div class="upload-icon">⬆️</div>
            <div class="upload-text">点击或拖拽上传图片</div>
            <img id="preview-image" alt="预览图片">
        </div>

        <h2>选择风格</h2>
            <div class="style-grid">
            <div class="style-option active" data-style="vangogh">
                <img src="./styles/vangogh.jpg" alt="梵高风格">
                <div class="style-name">梵高风格</div>
                </div>
                <div class="style-option" data-style="ukiyoe">
                <img src="./styles/ukiyoe.jpg" alt="浮世绘风格">
                <div class="style-name">浮世绘风格</div>
                </div>
            <div class="style-option" data-style="cyberpunk">
                <img src="./styles/cyberpunk.jpg" alt="赛博朋克风格">
                <div class="style-name">赛博朋克风格</div>
                </div>
            </div>

            <div class="action-buttons">
            <button class="action-button">应用风格</button>
            <button class="action-button undo">返回</button>
            </div>
    </main>

    <div class="camera-container">
        <video id="camera-video" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="camera-button close" onclick="closeCamera()">关闭</button>
            <button class="camera-button" onclick="takePhoto()">拍照</button>
        </div>
    </div>

    <div class="postcard-container">
        <div class="postcard-canvas-container">
            <canvas class="postcard-canvas"></canvas>
        </div>
        <div class="image-controls">
            <div>
                <label class="image-control-label">缩放</label>
                <input type="range" class="image-control-slider" id="scale-control" min="50" max="200" value="100">
            </div>
            <div>
                <label class="image-control-label">水平位置</label>
                <input type="range" class="image-control-slider" id="x-control" min="0" max="100" value="50">
            </div>
            <div>
                <label class="image-control-label">垂直位置</label>
                <input type="range" class="image-control-slider" id="y-control" min="0" max="100" value="50">
            </div>
        </div>
        <div class="postcard-controls">
            <button class="postcard-button" onclick="refreshTemplate()">换个模板</button>
            <button class="postcard-button" onclick="downloadPostcard()">下载</button>
            <button class="postcard-button close" onclick="closePostcard()">关闭</button>
        </div>
    </div>

    <div class="preview-modal">
        <div class="preview-image-container">
            <img id="generated-image" alt="生成的图片">
        </div>
        <div class="preview-text">双击图片生成明信片</div>
        <div class="preview-controls">
            <button class="preview-button close" onclick="closePreview()">关闭</button>
        </div>
    </div>

    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

    <div class="postcard-modal" role="dialog" aria-label="明信片预览">
        <div class="postcard-content">
            <div class="postcard-canvas-container">
                <canvas id="postcardCanvas"></canvas>
                <img id="postcard-download-image" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;">
            </div>
            <div class="image-controls">
                <div class="control-group">
                    <label class="image-control-label">缩放</label>
                    <input type="range" class="image-control-slider" id="postcard-scale-control" min="50" max="200" value="100">
                </div>
                <div class="control-group">
                    <label class="image-control-label">水平位置</label>
                    <input type="range" class="image-control-slider" id="postcard-x-control" min="0" max="100" value="50">
                </div>
                <div class="control-group">
                    <label class="image-control-label">垂直位置</label>
                    <input type="range" class="image-control-slider" id="postcard-y-control" min="0" max="100" value="50">
                </div>
            </div>
            <div class="postcard-controls">
                <button class="postcard-button" onclick="refreshTemplate()">换个模板</button>
                <button class="postcard-button" onclick="downloadPostcard()">下载</button>
            </div>
            <button class="close-preview" aria-label="关闭预览">&times;</button>
        </div>
    </div>

    <div class="background-animation-container" id="animation-container">
        <!-- 视频元素将由JavaScript动态添加 -->
    </div>

    <!-- 添加dom-to-image库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <!-- 添加开场动画的HTML结构 -->
    <div class="intro-screen" id="introScreen">
        <div class="intro-text" id="introText">点击开始艺术之旅</div>
    </div>

    <div class="intro-animation" id="introAnimation">
        <video id="introVideo" muted playsinline>
            <source src="./animations/start.webm" type="video/webm">
        </video>
    </div>

    <script>
        let currentStyle = 'vangogh';
        let originalImage = null;
        let stream = null;
        let imageHistory = [];

        const diamondContainer = document.getElementById('diamond-container');
        const maxDiamonds = 16;
        let activeDiamonds = 0;

        function getForbiddenAreas() {
            const areas = [];
            
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                const rect = uploadArea.getBoundingClientRect();
                areas.push(rect);
            }
            
            const navButtons = document.querySelector('.nav-buttons');
            if (navButtons) {
                const rect = navButtons.getBoundingClientRect();
                areas.push(rect);
            }
            
            const actionButtons = document.querySelector('.action-buttons');
            if (actionButtons) {
                const rect = actionButtons.getBoundingClientRect();
                areas.push(rect);
            }
            
            const styleGrid = document.querySelector('.style-grid');
            if (styleGrid) {
                const rect = styleGrid.getBoundingClientRect();
                areas.push(rect);
            }
            
            return areas;
        }

        function isInForbiddenArea(x, y, size, forbiddenAreas) {
            const diamondRect = {
                left: x,
                right: x + size,
                top: y,
                bottom: y + size
            };
            
            return forbiddenAreas.some(area => {
                return !(diamondRect.left > area.right ||
                    diamondRect.right < area.left ||
                    diamondRect.top > area.bottom ||
                    diamondRect.bottom < area.top);
            });
        }

        function createDiamond() {
            if (activeDiamonds >= maxDiamonds) return;
            
            const size = Math.random() * 20 + 20;
            const diamond = document.createElement('div');
            diamond.className = 'diamond';
            
            const forbiddenAreas = getForbiddenAreas();
            let x, y;
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                x = Math.random() * (window.innerWidth - size);
                y = Math.random() * (window.innerHeight - size);
                attempts++;
            } while (isInForbiddenArea(x, y, size, forbiddenAreas) && attempts < maxAttempts);
            
            if (attempts >= maxAttempts) return;
            
            diamond.style.width = size + 'px';
            diamond.style.height = size + 'px';
            diamond.style.left = x + 'px';
            diamond.style.top = y + 'px';
            
            diamond.addEventListener('click', () => {
                diamond.style.animation = 'fall 1s forwards';
                activeDiamonds--;
                
                setTimeout(() => {
                    diamond.remove();
                    createDiamond();
                }, 1000);
            });
            
            diamondContainer.appendChild(diamond);
            activeDiamonds++;
        }

        function initDiamonds() {
            diamondContainer.innerHTML = '';
            activeDiamonds = 0;
            
            for (let i = 0; i < maxDiamonds; i++) {
                setTimeout(() => createDiamond(), i * 100);
            }
        }

        window.addEventListener('load', function() {
            // 不再自动初始化星星
            // 页面加载时其他初始化工作可以放在这里
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            // 只有当星星功能激活时才在resize后重新初始化
            const starsToggle = document.getElementById('stars-toggle');
            if (starsToggle && starsToggle.classList.contains('active')) {
                resizeTimeout = setTimeout(initDiamonds, 300);
            }
        });

        document.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                currentStyle = option.dataset.style;
                updateStyleBackground();
            });
        });

        function updateStyleBackground() {
            document.querySelectorAll('.style-background').forEach(bg => {
                bg.classList.remove('active');
            });
            document.querySelector(`.style-background.${currentStyle}`).classList.add('active');
            
            updateBackgroundAnimation(currentStyle);
        }

        document.querySelector('.nav-button:not(.active)').addEventListener('click', openCamera);

        async function openCamera() {
            try {
                const cameraContainer = document.querySelector('.camera-container');
                const video = document.getElementById('camera-video');
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: { exact: 'environment' },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                }).catch(async () => {
                    return await navigator.mediaDevices.getUserMedia({ 
                        video: true
                    });
                });
                
                video.srcObject = stream;
                await video.play();
                
                cameraContainer.classList.add('active');
            } catch (err) {
                console.error('相机访问失败:', err);
                alert('无法访问相机，请检查权限设置');
            }
        }

        function closeCamera() {
            const cameraContainer = document.querySelector('.camera-container');
            const video = document.getElementById('camera-video');

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            cameraContainer.classList.remove('active');
        }

        function takePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            originalImage = canvas.toDataURL('image/jpeg');
            document.getElementById('preview-image').src = originalImage;
            document.querySelector('.upload-area').classList.add('has-image');
            
            closeCamera();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage = e.target.result;
                    document.getElementById('preview-image').src = originalImage;
                    document.querySelector('.upload-area').classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        }

        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#6C5CE7';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage = e.target.result;
                    document.getElementById('preview-image').src = originalImage;
                    document.querySelector('.upload-area').classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        });

        const poems = [
            ["春风十里不如你", "愿有岁月可回首", "且以深情共白头", "人间值得"],
            ["最是人间留不住", "朱颜辞镜花辞树", "明月装饰了别人的窗子", "你装饰了我的整个世界"],
            ["愿我如星君如月", "夜夜流光相皎洁", "情深不负相思意", "花好月圆人团圆"],
            ["云想衣裳花想容", "春风拂槛露华浓", "若非群玉山头见", "会向瑶台月下逢"]
        ];

        const borderStyles = [
            (ctx, width, height) => {
                ctx.strokeRect(10, 10, width - 20, height - 20);
                ctx.strokeRect(20, 20, width - 40, height - 40);
            },
            (ctx, width, height) => {
                const radius = 30;
                ctx.beginPath();
                ctx.moveTo(10, radius);
                ctx.arcTo(10, 10, radius, 10, radius);
                ctx.lineTo(width - radius, 10);
                ctx.arcTo(width - 10, 10, width - 10, radius, radius);
                ctx.lineTo(width - 10, height - radius);
                ctx.arcTo(width - 10, height - 10, width - radius, height - 10, radius);
                ctx.lineTo(radius, height - 10);
                ctx.arcTo(10, height - 10, 10, height - radius, radius);
                ctx.closePath();
                ctx.stroke();
            },
            (ctx, width, height) => {
                ctx.beginPath();
                for(let x = 10; x < width - 10; x += 20) {
                    ctx.moveTo(x, 10);
                    ctx.quadraticCurveTo(x + 10, 5, x + 20, 10);
                }
                for(let y = 10; y < height - 10; y += 20) {
                    ctx.moveTo(width - 10, y);
                    ctx.quadraticCurveTo(width - 5, y + 10, width - 10, y + 20);
                }
                for(let x = width - 10; x > 10; x -= 20) {
                    ctx.moveTo(x, height - 10);
                    ctx.quadraticCurveTo(x - 10, height - 5, x - 20, height - 10);
                }
                for(let y = height - 10; y > 10; y -= 20) {
                    ctx.moveTo(10, y);
                    ctx.quadraticCurveTo(5, y - 10, 10, y - 20);
                }
                ctx.stroke();
            }
        ];

        const decorationStyles = [
            (ctx, x, y, rotation) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.bezierCurveTo(10, -10, 20, -10, 30, 0);
                ctx.bezierCurveTo(20, 10, 10, 10, 0, 0);
                ctx.stroke();
                ctx.restore();
            },
            (ctx, x, y, rotation) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation);
                const petalCount = 5;
                const radius = 15;
                for(let i = 0; i < petalCount; i++) {
                    ctx.beginPath();
                    ctx.ellipse(radius, 0, 10, 5, (i * 2 * Math.PI) / petalCount, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                ctx.restore();
            },
            (ctx, x, y, rotation) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                for(let i = 0; i < 3; i++) {
                    ctx.bezierCurveTo(10, -10, 20, -10, 30, 0);
                    ctx.bezierCurveTo(40, 10, 50, 10, 60, 0);
                }
                ctx.stroke();
                for(let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.ellipse(20 + i * 20, -5, 5, 3, -Math.PI/4, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                ctx.restore();
            }
        ];

        async function compressImage(base64String, maxWidth = 1024) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = Math.floor(height * maxWidth / width);
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = base64String;
            });
        }

        function showGeneratedImage(imageUrl) {
            const modal = document.querySelector('.preview-modal');
            const generatedImage = document.getElementById('generated-image');
            
            // 创建新容器以确保事件正确绑定
            const container = document.querySelector('.preview-image-container');
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            
            // 获取新容器中的图像元素
            const img = newContainer.querySelector('img');
            img.src = imageUrl;
            
            // 确保双击事件绑定到图像而不是容器
            img.addEventListener('dblclick', function() {
                console.log('双击事件触发');
                modal.classList.remove('active'); // 关闭预览模态框
                generatePostcard(); // 生成明信片
            });
            
            img.onerror = function() {
                console.error('图片加载失败:', imageUrl);
                alert('图片加载失败，请重试');
            };
            
            // 更新上传区域的预览图
            const previewImage = document.getElementById('preview-image');
            previewImage.src = imageUrl;
            document.querySelector('.upload-area').classList.add('has-image');
            
            // 显示模态框
            modal.classList.add('active');
        }

        // 服务器URL配置
        function getServerUrl() {
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isGitHubPages = window.location.hostname.includes('github.io');
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isLocalhost || isFileProtocol) {
                return 'http://localhost:5000'; // 本地开发环境
            } else if (isGitHubPages) {
                return 'http://10.61.190.5:5000'; // 使用你的实际IP地址
            }
            return 'http://localhost:5000'; // 默认
        }

        document.addEventListener('DOMContentLoaded', function() {
            const applyButton = document.querySelector('.action-button:not(.undo)');
            const previewImage = document.getElementById('preview-image');
            const styleSelect = document.querySelector('.style-option.active');

            applyButton.addEventListener('click', async () => {
                try {
                    if (!previewImage.src || previewImage.src === window.location.href) {
                        alert('请先上传图片');
                        return;
                    }

                    applyButton.disabled = true;
                    applyButton.textContent = '处理中...';

                    imageHistory.push(previewImage.src);

                    const compressedImage = await compressImage(previewImage.src);

                    const selectedStyle = document.querySelector('.style-option.active').dataset.style;

                    // 使用动态获取的服务器URL而不是硬编码的localhost
                    const serverUrl = getServerUrl();
                    const response = await fetch(`${serverUrl}/process_image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            image: compressedImage,
                            style: selectedStyle
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    showGeneratedImage(data.image);

                } catch (error) {
                    console.error('Error:', error);
                    alert('图片处理失败: ' + (error.message || '未知错误'));
                    if (imageHistory.length > 0) {
                        previewImage.src = imageHistory.pop();
                    }
                } finally {
                    applyButton.disabled = false;
                    applyButton.textContent = '应用风格';
                }
            });
        });

        const backButton = document.querySelector('.action-button.undo');
        if (backButton) {
            backButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const previewModal = document.querySelector('.preview-modal');
                const postcardModal = document.querySelector('.postcard-modal');
                
                if (previewModal && previewModal.classList.contains('active')) {
                    closePreview();
                    return;
                }
                
                if (postcardModal && postcardModal.classList.contains('active')) {
                    closePreview();
                    return;
                }
                
                if (imageHistory.length > 0) {
                    const lastImage = imageHistory.pop();
                    document.getElementById('preview-image').src = lastImage;
                } else {
                    const previewImage = document.getElementById('preview-image');
                    if (previewImage.src && previewImage.src !== window.location.href) {
                        previewImage.src = '';
                        document.querySelector('.upload-area').classList.remove('has-image');
                    }
                }
            });
        }

        let currentTemplate = null;
        let currentTemplateIndex = 1;
        let imageScale = 1;
        let imageX = 0.5;
        let imageY = 0.5;
        let templateCount = 13;

        document.getElementById('postcard-scale-control').addEventListener('input', (e) => {
            imageScale = e.target.value / 100;
            redrawPostcard();
        });

        document.getElementById('postcard-x-control').addEventListener('input', (e) => {
            imageX = e.target.value / 100;
            redrawPostcard();
        });

        document.getElementById('postcard-y-control').addEventListener('input', (e) => {
            imageY = e.target.value / 100;
            redrawPostcard();
        });

        // 修改明信片模板加载函数，使其更具弹性
        async function loadTemplate(index) {
            return new Promise((resolve, reject) => {
                console.log(`尝试加载模板 ${index}...`);
                const img = new Image();
                
                img.onload = function() {
                    console.log(`模板 ${index} 加载成功，尺寸: ${img.width}x${img.height}`);
                    resolve(img);
                };
                
                img.onerror = function(err) {
                    console.error(`模板 ${index} 加载失败，尝试备用路径:`, err);
                    
                    // 尝试使用备用路径
                    const backupImg = new Image();
                    backupImg.onload = function() {
                        console.log(`模板 ${index} 通过备用路径加载成功`);
                        resolve(backupImg);
                    };
                    
                    backupImg.onerror = function(backupErr) {
                        console.error(`模板 ${index} 所有路径均加载失败:`, backupErr);
                        reject(backupErr);
                    };
                    
                    // 尝试备用路径 - 处理相对路径问题
                    backupImg.src = `./templates/${index}.png?t=${Date.now()}`;
                };
                
                // 设置图片源 - 添加时间戳避免缓存问题
                const timestamp = Date.now();
                img.src = `templates/${index}.png?t=${timestamp}`;
            });
        }

        // 预加载所有模板到内存中
        const preloadedTemplates = {};
        async function preloadTemplates() {
            console.log('开始预加载模板...');
            
            try {
                for (let i = 1; i <= templateCount; i++) {
                    try {
                        preloadedTemplates[i] = await loadTemplate(i);
                        console.log(`预加载模板 ${i} 成功`);
                    } catch (err) {
                        console.error(`预加载模板 ${i} 失败:`, err);
                    }
                }
                
                // 记录成功加载的模板索引
                const loadedIndices = Object.keys(preloadedTemplates);
                console.log(`模板预加载完成，成功加载 ${loadedIndices.length} 个模板`);
                console.log('成功加载的模板索引:', loadedIndices);
            } catch (err) {
                console.error('模板预加载过程中出错:', err);
            }
        }

        // 创建一个简单的模板，以防所有模板加载失败
        function createFallbackTemplate(width, height) {
            const canvas = document.createElement('canvas');
            canvas.width = width || 800;
            canvas.height = height || 600;
            const ctx = canvas.getContext('2d');
            
            // 设置白色背景
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制边框
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 10;
            ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
            
            // 添加明信片标记
            ctx.fillStyle = '#000000';
            ctx.font = '30px Arial';
            ctx.fillText('艺境明信片', canvas.width / 2 - 80, 40);
            
            // 转换为图像
            const img = new Image();
            img.src = canvas.toDataURL('image/png');
            return img;
        }

        // 重绘明信片
        function redrawPostcard() {
            console.log('重绘明信片...');
            const canvas = document.getElementById('postcardCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) {
                console.error('找不到postcardCanvas或上下文');
                return;
            }
            
            if (currentTemplate) {
                console.log('使用模板尺寸:', currentTemplate.width, 'x', currentTemplate.height);
            } else {
                console.warn('没有当前模板');
            }

            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const generatedImage = document.getElementById('generated-image');
            if (generatedImage && generatedImage.src && generatedImage.src !== window.location.href) {
                console.log('绘制生成的图像');
                
                try {
                    const imgWidth = generatedImage.naturalWidth;
                    const imgHeight = generatedImage.naturalHeight;
                    
                    console.log('图像原始尺寸:', imgWidth, 'x', imgHeight);
                    
                    if (imgWidth === 0 || imgHeight === 0) {
                        console.warn('图像尺寸为0，可能未完全加载');
                        return;
                    }
                    
                    // 计算缩放比例
                    const baseScale = Math.min(canvas.width / imgWidth, canvas.height / imgHeight);
                    const finalScale = baseScale * imageScale;
                    
                    // 计算绘制尺寸
                    const scaledWidth = imgWidth * finalScale;
                    const scaledHeight = imgHeight * finalScale;
                    
                    // 计算位置
                    const maxX = canvas.width - scaledWidth;
                    const maxY = canvas.height - scaledHeight;
                    const x = Math.min(Math.max(0, maxX * imageX), maxX);
                    const y = Math.min(Math.max(0, maxY * imageY), maxY);

                    console.log('绘制参数:', {
                        x, y, 
                        scaledWidth, scaledHeight, 
                        imageScale, imageX, imageY
                    });

                    // 先绘制图像
                    ctx.drawImage(generatedImage, x, y, scaledWidth, scaledHeight);
                    
                    // 再绘制模板（确保在图像上方）
                    if (currentTemplate) {
                        ctx.drawImage(currentTemplate, 0, 0, canvas.width, canvas.height);
                    }
                    
                    // 在绘制完成后，将canvas内容转为data URL更新下载图像
                    try {
                        document.getElementById('postcard-download-image').src = canvas.toDataURL('image/png');
                    } catch (e) {
                        console.error('无法创建下载图像:', e);
                    }
                    
                } catch (error) {
                    console.error('绘制图像时出错:', error);
                }
            } else {
                console.warn('没有找到生成的图像或图像未加载');
                
                // 如果没有图像，至少绘制模板
                if (currentTemplate) {
                    ctx.drawImage(currentTemplate, 0, 0, canvas.width, canvas.height);
                    
                    // 尝试更新下载图像
                    try {
                        document.getElementById('postcard-download-image').src = canvas.toDataURL('image/png');
                    } catch (e) {
                        console.error('无法创建下载图像:', e);
                    }
                }
            }
        }

        // 使用预加载的模板刷新当前模板
        async function refreshTemplate() {
            try {
                const currentIndex = currentTemplateIndex;
                
                // 检查是否有预加载的模板
                const preloadedIndices = Object.keys(preloadedTemplates).map(Number);
                if (preloadedIndices.length === 0) {
                    console.warn('没有成功预加载的模板，使用备用模板');
                    currentTemplate = createFallbackTemplate();
                    redrawPostcard();
                    return;
                }
                
                // 从成功加载的模板中选择一个不同的
                let newIndex;
                do {
                    const randomIndex = Math.floor(Math.random() * preloadedIndices.length);
                    newIndex = preloadedIndices[randomIndex];
                } while (newIndex === currentIndex && preloadedIndices.length > 1);
                
                currentTemplateIndex = newIndex;
                console.log(`切换到模板 ${currentTemplateIndex}`);
                
                // 使用预加载的模板
                currentTemplate = preloadedTemplates[currentTemplateIndex];
                
                redrawPostcard();
                console.log('模板刷新成功');
            } catch (error) {
                console.error('模板刷新失败:', error);
                
                // 使用备用模板
                console.warn('使用备用模板');
                currentTemplate = createFallbackTemplate();
                redrawPostcard();
            }
        }

        // 生成明信片
        async function generatePostcard() {
            console.log('生成明信片...');
            const canvas = document.getElementById('postcardCanvas');
            const ctx = canvas.getContext('2d');
            
            try {
                // 检查是否有预加载的模板
                const preloadedIndices = Object.keys(preloadedTemplates).map(Number);
                
                if (preloadedIndices.length === 0) {
                    // 如果没有预加载成功，尝试直接加载一个模板
                    try {
                        currentTemplateIndex = 1;
                        console.log('尝试直接加载模板...');
                        currentTemplate = await loadTemplate(currentTemplateIndex);
                        console.log('直接加载模板成功');
                    } catch (err) {
                        console.error('直接加载模板失败，使用备用模板');
                        currentTemplate = createFallbackTemplate();
                    }
                } else {
                    // 从预加载的模板中随机选择一个
                    const randomIndex = Math.floor(Math.random() * preloadedIndices.length);
                    currentTemplateIndex = preloadedIndices[randomIndex];
                    currentTemplate = preloadedTemplates[currentTemplateIndex];
                    console.log(`使用预加载的模板 ${currentTemplateIndex}`);
                }
                
                // 设置画布尺寸
                canvas.width = currentTemplate.width || 800;
                canvas.height = currentTemplate.height || 600;
                console.log(`画布尺寸设置为 ${canvas.width}x${canvas.height}`);
                
                // 重置控制值
                document.getElementById('postcard-scale-control').value = 100;
                document.getElementById('postcard-x-control').value = 50;
                document.getElementById('postcard-y-control').value = 50;
                imageScale = 1;
                imageX = 0.5;
                imageY = 0.5;
                
                // 绘制明信片
                redrawPostcard();
                
                // 显示明信片模态框
                const postcardModal = document.querySelector('.postcard-modal');
                postcardModal.classList.add('active');
                console.log('明信片模态框已显示:', postcardModal.classList.contains('active'));
                console.log('明信片生成成功');
            } catch (error) {
                console.error('明信片生成失败:', error);
                alert('加载模板失败，请重试');
            }
        }

        // 使用dom-to-image库下载明信片
        function downloadPostcard() {
            // 获取明信片容器元素
            const postcardContainer = document.querySelector('.postcard-canvas-container');
            
            if (!postcardContainer) {
                console.error('找不到明信片容器');
                alert('下载失败，找不到明信片容器');
                return;
            }
            
            // 显示加载提示
            const loadingMsg = document.createElement('div');
            loadingMsg.textContent = '正在准备下载...';
            loadingMsg.style.position = 'absolute';
            loadingMsg.style.top = '50%';
            loadingMsg.style.left = '50%';
            loadingMsg.style.transform = 'translate(-50%, -50%)';
            loadingMsg.style.background = 'rgba(0,0,0,0.7)';
            loadingMsg.style.color = 'white';
            loadingMsg.style.padding = '10px 20px';
            loadingMsg.style.borderRadius = '5px';
            loadingMsg.style.zIndex = '9999';
            document.body.appendChild(loadingMsg);
            
            // 使用dom-to-image将DOM元素转换为图像
            domtoimage.toPng(postcardContainer)
                .then(function(dataUrl) {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `艺境明信片_${new Date().getTime()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 移除加载提示
                    document.body.removeChild(loadingMsg);
                    console.log('明信片下载成功');
                })
                .catch(function(error) {
                    console.error('下载失败:', error);
                    
                    // 移除加载提示
                    document.body.removeChild(loadingMsg);
                    
                    // 备用下载方法：直接下载生成的图像
                    const generatedImage = document.getElementById('generated-image');
                    if (generatedImage && generatedImage.src && generatedImage.src !== window.location.href) {
                        console.log('使用备用方法下载图像');
                        const link = document.createElement('a');
                        link.href = generatedImage.src;
                        link.download = `艺境原图_${new Date().getTime()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert('下载失败，请重试');
                    }
                });
        }

        function closePostcard() {
            document.querySelector('.postcard-container').classList.remove('active');
        }

        function closePreview() {
            const previewModal = document.querySelector('.preview-modal');
            const postcardModal = document.querySelector('.postcard-modal');
            
            if (previewModal) {
                previewModal.classList.remove('active');
            }
            
            if (postcardModal) {
                postcardModal.classList.remove('active');
            }
            
            const generatedImage = document.getElementById('generated-image');
            const previewImage = document.getElementById('preview-image');
            
            if (generatedImage && generatedImage.src && generatedImage.src !== window.location.href) {
                previewImage.src = generatedImage.src;
                document.querySelector('.upload-area').classList.add('has-image');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.close-preview').forEach(button => {
                button.onclick = closePreview;
            });

            document.querySelectorAll('.preview-modal, .postcard-modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closePreview();
                    }
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePreview();
                }
            });

            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            toast.style.zIndex = '9999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            toast.textContent = '返回按钮已修复，现在可以返回上一步操作';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '1';
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 500);
                }, 3000);
            }, 1000);
            
            // 星星控制逻辑
            const starsToggle = document.getElementById('stars-toggle');
            let starsActive = false;
            
            starsToggle.addEventListener('click', function() {
                if (starsActive) {
                    // 关闭星星
                    starsActive = false;
                    starsToggle.classList.remove('active');
                    fadeOutStars();
                } else {
                    // 开启星星
                    starsActive = true;
                    starsToggle.classList.add('active');
                    initDiamonds();
                }
            });
            
            function fadeOutStars() {
                const diamonds = document.querySelectorAll('.diamond');
                diamonds.forEach((diamond, index) => {
                    setTimeout(() => {
                        diamond.style.animation = 'fall 1s forwards';
                        setTimeout(() => {
                            if (diamond.parentNode) {
                                diamond.parentNode.removeChild(diamond);
                            }
                        }, 1000);
                    }, index * 50);
                });
                activeDiamonds = 0;
            }
            
            // 初始星星状态为关闭
            diamondContainer.innerHTML = '';
            activeDiamonds = 0;
            
            // 初始化当前风格的动画
            updateBackgroundAnimation(currentStyle);

            // 预加载所有模板
            preloadTemplates();

            // 为所有风格选项图片添加错误处理
            document.querySelectorAll('.style-option img').forEach(img => {
                handleImageError(img, './styles/default-style.jpg');
            });
        });

        // 修改动画路径配置，增加资源加载的灵活性
        const styleAnimations = {
            vangogh: {
                intro: './animations/vangogh_intro.webm',
                loop: './animations/vangogh_loop.webm',
                fallback: {
                    intro: './animations/vangogh_intro.webm',
                    loop: './animations/vangogh_loop.webm'
                }
            },
            ukiyoe: {
                intro: './animations/ukiyoe_intro.webm',
                loop: './animations/ukiyoe_loop.webm',
                fallback: {
                    intro: './animations/ukiyoe_intro.webm',
                    loop: './animations/ukiyoe_loop.webm'
                }
            },
            cyberpunk: {
                intro: './animations/cyberpunk_intro.webm',
                loop: './animations/cyberpunk_loop.webm',
                fallback: {
                    intro: './animations/vangogh_intro.webm', // 如果加载失败，使用梵高风格作为备用
                    loop: './animations/vangogh_loop.webm'
                }
            }
        };

        let currentAnimationVideo = null;
        let loopAnimationVideo = null;

        // 更新背景动画播放逻辑，增加错误处理和回退逻辑
        function updateBackgroundAnimation(style) {
            const animationContainer = document.getElementById('animation-container');
            
            // 清除现有动画
            if (currentAnimationVideo) {
                currentAnimationVideo.pause();
                if (currentAnimationVideo.parentNode) {
                    animationContainer.removeChild(currentAnimationVideo);
                }
                currentAnimationVideo = null;
            }
            
            if (loopAnimationVideo) {
                loopAnimationVideo.pause();
                if (loopAnimationVideo.parentNode) {
                    animationContainer.removeChild(loopAnimationVideo);
                }
                loopAnimationVideo = null;
            }
            
            // 检查动画文件是否存在
            if (!styleAnimations[style]) {
                console.error(`未找到风格 ${style} 的动画配置`);
                return;
            }
            
            // 尝试加载指定风格的动画
            let introSrc = styleAnimations[style].intro;
            let loopSrc = styleAnimations[style].loop;
            
            // 创建入场动画视频元素
            const introVideo = document.createElement('video');
            introVideo.className = 'background-animation active';
            introVideo.muted = true;
            introVideo.playsInline = true;
            introVideo.autoplay = true;
            introVideo.setAttribute('playsinline', '');
            introVideo.setAttribute('webkit-playsinline', '');
            
            // 创建循环动画视频元素
            const loopVideo = document.createElement('video');
            loopVideo.className = 'background-animation';
            loopVideo.muted = true;
            loopVideo.playsInline = true;
            loopVideo.loop = true;
            loopVideo.autoplay = true;
            loopVideo.setAttribute('playsinline', '');
            loopVideo.setAttribute('webkit-playsinline', '');
            
            // 添加到容器
            animationContainer.appendChild(introVideo);
            animationContainer.appendChild(loopVideo);
            
            // 保存引用
            currentAnimationVideo = introVideo;
            loopAnimationVideo = loopVideo;
            
            // 添加source元素以支持多种格式
            const introSource = document.createElement('source');
            introSource.src = introSrc;
            introSource.type = 'video/webm';
            introVideo.appendChild(introSource);
            
            const loopSource = document.createElement('source');
            loopSource.src = loopSrc;
            loopSource.type = 'video/webm';
            loopVideo.appendChild(loopSource);
            
            // 错误处理 - 如果主要动画加载失败，尝试使用备用动画
            introVideo.addEventListener('error', () => {
                console.warn(`入场动画 ${introSrc} 加载失败，尝试使用备用动画`);
                if (styleAnimations[style].fallback) {
                    introSource.src = styleAnimations[style].fallback.intro;
                    introVideo.load();
                }
            });
            
            loopVideo.addEventListener('error', () => {
                console.warn(`循环动画 ${loopSrc} 加载失败，尝试使用备用动画`);
                if (styleAnimations[style].fallback) {
                    loopSource.src = styleAnimations[style].fallback.loop;
                    loopVideo.load();
                }
            });
            
            // 视频加载元数据后设置状态
            introVideo.addEventListener('loadedmetadata', () => {
                console.log(`入场动画元数据加载成功: ${introVideo.videoWidth}x${introVideo.videoHeight}`);
            });
            
            loopVideo.addEventListener('loadedmetadata', () => {
                console.log(`循环动画元数据加载成功: ${loopVideo.videoWidth}x${loopVideo.videoHeight}`);
            });
            
            // 播放入场动画，结束后切换到循环动画
            introVideo.play().catch(error => {
                console.error('入场动画播放失败:', error);
                // 如果入场动画播放失败，直接播放循环动画
                introVideo.classList.remove('active');
                loopVideo.classList.add('active');
                loopVideo.play().catch(err => {
                    console.error('循环动画播放失败:', err);
                    
                    // 尝试使用替代方法播放
                    setTimeout(() => {
                        loopVideo.load();
                        loopVideo.play().catch(e => console.error('二次尝试播放循环动画失败:', e));
                    }, 500);
                });
            });
            
            introVideo.addEventListener('ended', () => {
                // 入场动画结束后
                console.log('入场动画播放完成，切换到循环动画');
                introVideo.classList.remove('active');
                loopVideo.classList.add('active');
                
                // 开始播放循环动画
                loopVideo.play().catch(error => {
                    console.error('循环动画播放失败:', error);
                    
                    // 尝试使用替代方法播放
                    setTimeout(() => {
                        loopVideo.load();
                        loopVideo.play().catch(e => console.error('循环动画播放重试失败:', e));
                    }, 500);
                });
                
                // 延迟后移除入场动画元素
                setTimeout(() => {
                    if (introVideo.parentNode) {
                        animationContainer.removeChild(introVideo);
                    }
                }, 500);
            });
        }

        // 添加图片加载错误处理函数
        function handleImageError(img, fallbackSrc) {
            img.onerror = function() {
                console.warn(`图片加载失败: ${img.src}`);
                if (fallbackSrc) {
                    console.log(`尝试加载备用图片: ${fallbackSrc}`);
                    img.src = fallbackSrc;
                }
            };
            return img;
        }

        // 开场动画的JavaScript
        (function() {
            // 检查是否已经展示过开场动画 - 移除会话存储，每次刷新都显示
            // const hasSeenIntro = sessionStorage.getItem('hasSeenIntro');
            const hasSeenIntro = false; // 强制每次都显示
            const introScreen = document.getElementById('introScreen');
            const introText = document.getElementById('introText');
            const introAnimation = document.getElementById('introAnimation');
            const introVideo = document.getElementById('introVideo');
            
            // 如果在当前会话中已经看过开场动画，就跳过
            if (hasSeenIntro) {
                introScreen.classList.add('hidden');
                startMainApplication();
                return;
            }
            
            // 创建涟漪效果
            let rippleCount = 0;
            const maxRipples = 10; // 修改为10个最大涟漪
            
            // 初始随机涟漪
            generateRandomRipples(3); // 开始生成3个初始涟漪
            
            // 点击屏幕生成涟漪
            introScreen.addEventListener('click', function(e) {
                if (e.target !== introText) {
                    createRipple(e.clientX, e.clientY);
                }
            });
            
            // 点击文字开始动画 - 移除淡出效果
            introText.addEventListener('click', function() {
                // 直接隐藏而不是添加hidden类
                introScreen.style.display = 'none';
                
                // 立即显示动画容器
                introAnimation.style.display = 'block';
                
                // 播放视频
                introVideo.play();
                
                // 视频结束后启动应用
                introVideo.addEventListener('ended', function() {
                    introAnimation.style.display = 'none';
                    startMainApplication();
                    
                    // 不再记录已展示开场动画，确保每次刷新都显示
                    // sessionStorage.setItem('hasSeenIntro', 'true');
                });
                
                // 设置安全超时，以防视频无法播放
                setTimeout(() => {
                    if (!introVideo.ended) {
                        introAnimation.style.display = 'none';
                        startMainApplication();
                        // sessionStorage.setItem('hasSeenIntro', 'true');
                    }
                }, 5000); // 设置比视频长度稍长一些的超时时间
            });
            
            // 创建涟漪效果
            function createRipple(x, y) {
                if (rippleCount >= maxRipples) return;
                
                // 生成随机透明度 (60%-100%)
                const randomOpacity = (Math.random() * 0.4 + 0.6).toFixed(2);
                
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                // 设置自定义CSS变量，用于所有子元素的透明度
                ripple.style.setProperty('--ripple-opacity', randomOpacity);
                
                // 添加所有同心圆层
                const circle1 = document.createElement('div');
                circle1.className = 'circle-1';
                ripple.appendChild(circle1);
                
                const circle2 = document.createElement('div');
                circle2.className = 'circle-2';
                ripple.appendChild(circle2);
                
                const circle3 = document.createElement('div');
                circle3.className = 'circle-3';
                ripple.appendChild(circle3);
                
                const circle4 = document.createElement('div');
                circle4.className = 'circle-4';
                ripple.appendChild(circle4);
                
                const circle5 = document.createElement('div');
                circle5.className = 'circle-5';
                ripple.appendChild(circle5);
                
                const circle6 = document.createElement('div');
                circle6.className = 'circle-6';
                ripple.appendChild(circle6);
                
                const circle7 = document.createElement('div');
                circle7.className = 'circle-7';
                ripple.appendChild(circle7);
                
                // 添加中心点
                const innerDot = document.createElement('div');
                innerDot.className = 'inner-dot';
                ripple.appendChild(innerDot);
                
                introScreen.appendChild(ripple);
                
                rippleCount++;
                
                // 动画结束后移除涟漪 - 调整为4秒以匹配新的动画持续时间
                setTimeout(function() {
                    if (ripple.parentNode) { // 检查父节点是否存在
                        introScreen.removeChild(ripple);
                    }
                    rippleCount--;
                    
                    // 随机生成新的涟漪
                    if (Math.random() < 0.5) {
                        generateRandomRipple();
                    }
                }, 4000); // 与动画时长匹配，延长至4秒
            }
            
            // 生成随机位置的涟漪
            function generateRandomRipple() {
                if (rippleCount >= maxRipples) return;
                
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                createRipple(x, y);
            }
            
            // 生成多个随机涟漪
            function generateRandomRipples(count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        generateRandomRipple();
                    }, i * 200);
                }
                
                // 定时生成下一批随机涟漪
                setTimeout(() => {
                    if (document.getElementById('introScreen').style.display !== 'none') {
                        generateRandomRipples(Math.floor(Math.random() * 3) + 1);
                    }
                }, 2000);
            }
            
            // 启动主应用程序
            function startMainApplication() {
                // 初始化风格动画
                updateBackgroundAnimation(currentStyle);
            }
        })();
    </script>
</body>
</html> 